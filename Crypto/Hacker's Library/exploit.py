#!/usr/bin/env python3
from hashpumpy import hashpump
from base64 import b64encode, b64decode
from json import dumps, loads
from sys import argv
from pwn import *

def establish_connection(ip : str = "34.78.240.11", port : int = 65126):
    r = remote(ip, port)
    return r

def consume_info(connection):
    connection.recvuntil(b"Your choice:")

def get_normal_ticket(connection):
    connection.sendline(b"1")
    return connection.recv()

def send_ticket(connection, ticket : str):
    connection.sendline(b"2")
    connection.recvuntil(b"Ticket:")
    connection.sendline(ticket.encode())

def generate_exploit_ticket(ticket : str) -> str:
    js = loads(ticket)
    result = hashpump(js["proof"], b64decode(js["book"]).decode(), ";flag", 256)
    return dumps({"book":b64encode(result[1]).decode(), "proof":result[0]})

if __name__=="__main__":
    r = establish_connection()
    consume_info(r)
    ticket = get_normal_ticket(r).strip().decode()
    crafted = generate_exploit_ticket(ticket)
    r = establish_connection()
    consume_info(r)
    send_ticket(r, crafted)
    flag = r.recv().decode().strip().split()[-1]
    print(flag)
    
